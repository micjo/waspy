{% extends "base.html" %}
{% block title %}Welcome{% endblock %}
{% block content %}

<h1>CAEN Data acquisition</h1>
<label for="channel">Choose a Channel:</label>

<select name="channels" id="channels">
  <option value="board0-channel0">board 0 channel 0</option>
  <option value="board0-channel1">board 0 channel 1</option>
  <option value="board0-channel2">board 0 channel 2</option>
  <option value="board0-channel3">board 0 channel 3</option>
  <option value="board0-channel4">board 0 channel 4</option>
  <option value="board0-channel5">board 0 channel 5</option>
  <option value="board0-channel6">board 0 channel 6</option>
  <option value="board0-channel7">board 0 channel 7</option>
  <option value="board0-channel8">board 0 channel 8</option>
  <option value="board1-channel0">board 1 channel 0</option>
  <option value="board1-channel1">board 1 channel 1</option>
  <option value="board1-channel2">board 1 channel 2</option>
  <option value="board1-channel3">board 1 channel 3</option>
  <option value="board1-channel4">board 1 channel 4</option>
  <option value="board1-channel5">board 1 channel 5</option>
  <option value="board1-channel6">board 1 channel 6</option>
  <option value="board1-channel7">board 1 channel 7</option>
  <option value="board1-channel8">board 1 channel 8</option>
  <option value="board1-channel9">board 1 channel 9</option>
  <option value="board1-channel10">board 1 channel 10</option>
  <option value="board1-channel11">board 1 channel 11</option>
  <option value="board1-channel12">board 1 channel 12</option>
  <option value="board1-channel13">board 1 channel 13</option>
  <option value="board1-channel14">board 1 channel 14</option>
  <option value="board1-channel15">board 1 channel 15</option>
</select> 
<div class="container">
  <canvas id="chart" width="800" height="600"></canvas>
</div> 
<div class="container"><label> update</label><input type="checkbox" id="update_chart"> </div>

<script>
  window.setInterval(function(){
    refreshData();
},1000)

//var lineChart
Chart.defaults.global.animationSteps = 0;

Chart.defaults.global.tooltipYPadding = 16;
Chart.defaults.global.tooltipCornerRadius = 0;
Chart.defaults.global.tooltipTitleFontStyle = "normal";
Chart.defaults.global.tooltipFillColor = "rgba(0,0,0,0.8)";
Chart.defaults.global.animationEasing = "easeOutBounce";
Chart.defaults.global.responsive = false;
Chart.defaults.global.scaleLineColor = "black";
Chart.defaults.global.scaleFontSize = 16;


let x_coordinates = [];
let y_coordinates = [];
var ctx = document.getElementById('chart').getContext('2d');
/*lineChart = new Chart(ctx, {
  // The type of chart we want to create
  type: 'line',

  // The data for our dataset
  data: {
      labels: [],
      datasets: [{
          label: 'Histogram Board 0 CHannel 0',
          data: [],
          backgroundColor: 'rgba(242, 207, 222, 0.40)'
      }]
  },

  // Configuration options go here
  options: {
    animation: {
      duration: 0
    }
  }
});*/


let lineChart = new Chart(ctx, {
  // The type of chart we want to create
  type: 'scatter',

  // The data for our dataset
  data: {
      labels: [],
      datasets: [{
          label: 'Histogram Board 0 Channel 0',
          backgroundColor: 'rgba(242, 207, 222, 0.40)'
      }]
  },

  // Configuration options go here
  options: {
    animation: {
      duration: 0
    } 
  }
});
  

function updateGraph(channelId, jsonData) {
  data = JSON.parse(jsonData);
  let channelData;
  if (channelId === "board0-channel0" ) {
    console.log("selected board 0 channel 0");
    channelData = data["Board-0"]["Channel-0"]["energy_histogram"];
    lineChart.data.datasets[0].label = "Histrogram Board 0 (V1782) Channel 0";
  }
  
  if (channelId === "board1-channel0") {
    console.log("selected board 1 channel 0");
    channelData = data["Board-1"]["Channel-0"]["energy_histogram"];
    lineChart.data.datasets[0].label = "Histrogram Board 1 (V1725) Channel 0";
  }

  lineChart.data.datasets[0].data = [];
  dataStrList = channelData.split(";");
  for (const point of dataStrList) {
      if(point) {
        x_and_y = point.split(",");
        element = {
          x: parseInt(x_and_y[0]),
          y: parseInt(x_and_y[1])
        };

        lineChart.data.datasets[0].data.push(element);
      }
  }
}

function refreshData() {
  console.log("hello");
  let url = "http://DESKTOP-GL7PJ05:22123/liveData";
  let xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4)
    {
      console.log(xhr.response);
      if (lineChart) {
        selectedChannel = document.getElementById("channels").value;
        console.log(selectedChannel);
        updateGraph(selectedChannel, xhr.response);
        lineChart.update();
      }

    }
  }

  if (document.getElementById("update_chart").checked) 
  {
    xhr.open("GET", url, true);
    xhr.setRequestHeader("Content-Type","text/plain;charset=UTF-8");
    xhr.send();
  }
}

</script>




{% endblock %}
